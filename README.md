# .NET Core 3 and SourceLink are now broken (gasp!)

This repository contains the steps and script to reproduce a weird problem I
encountered while using `sourcelink` to test .NET assemblies generated by .NET
Core 3. Bear with me, this is obscure and I'm still wrapping my head around
what's changed to introduce this bug.

To see this bug, you need to install .NET Core `3.1`. I used `global.json` with
each step to ensure we're testing the right behaviour, so you might need to
install different SDKs yourself.

## What happened?

With that installed, run the `repro.sh` script at the root of the repository.

You'll see this output:

```
$ ./repro.sh
Tool 'sourcelink' (version '3.1.1') was restored. Available commands: sourcelink

Restore was successful.
Microsoft (R) Build Engine version 16.4.0+e901037fe for .NET Core
Copyright (C) Microsoft Corporation. All rights reserved.

  Restore completed in 152.28 ms for /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/dotnetcore-sourcelink-test-bug.csproj.
  dotnetcore-sourcelink-test-bug -> /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/bin/Release/netstandard2.0/dotnetcore-sourcelink-test-bug.dll
  dotnetcore-sourcelink-test-bug -> /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/bin/Release/net45/dotnetcore-sourcelink-test-bug.dll
  Successfully created package '/Users/shiftkey/src/dotnetcore-sourcelink-test-bug/bin/Release/dotnetcore-sourcelink-test-bug.1.0.0.nupkg'.
1 Documents without URLs:
5876ae9f3f92fca88b3580b716c89b4d2b563514082e43463bc4ff646a4246cd sha256 csharp /var/folders/pp/1_6b120j6cs4w1bmhk9qgmy80000gn/T/.NETFramework,Version=v4.5.AssemblyAttributes.cs
1 Documents with errors:
f3065b6d23b18072f77d1d9d099111c74f7ceb8b4d166dcab3687c5c77c3dc86 sha256 csharp /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/obj/Release/net45/dotnetcore-sourcelink-test-bug.AssemblyInfo.cs
https://raw.githubusercontent.com/shiftkey/dotnetcore-sourcelink-test-bug/4eab433d7b140dda2936f54ef0240f8b9b614554/obj/Release/net45/dotnetcore-sourcelink-test-bug.AssemblyInfo.cs
error: url failed NotFound: Not Found
sourcelink test failed
failed for lib/net45/dotnetcore-sourcelink-test-bug.dll
1 Documents without URLs:
74a35b2e0310ee692c4338531afedfe18376f44d57ebf83466e7e6a5b80e2d14 sha256 csharp /var/folders/pp/1_6b120j6cs4w1bmhk9qgmy80000gn/T/.NETStandard,Version=v2.0.AssemblyAttributes.cs
1 Documents with errors:
f3065b6d23b18072f77d1d9d099111c74f7ceb8b4d166dcab3687c5c77c3dc86 sha256 csharp /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/obj/Release/netstandard2.0/dotnetcore-sourcelink-test-bug.AssemblyInfo.cs
https://raw.githubusercontent.com/shiftkey/dotnetcore-sourcelink-test-bug/4eab433d7b140dda2936f54ef0240f8b9b614554/obj/Release/netstandard2.0/dotnetcore-sourcelink-test-bug.AssemblyInfo.cs
error: url failed NotFound: Not Found
sourcelink test failed
failed for lib/netstandard2.0/dotnetcore-sourcelink-test-bug.dll
2 files did not pass in bin/Release/dotnetcore-sourcelink-test-bug.1.0.0.nupkg
```

The last part is the relevant bug report, and this seems to be a combination of:

 - .NET Core 3.x
 - class library targeting multiple platforms
 - generated file with assembly info

## What should happen?

To see what should happen, switch to the `netcore21` branch. I tested this
against .NET Core `2.1.803`:

```
$ ./repro.sh
Microsoft (R) Build Engine version 16.2.37902+b5aaefc9f for .NET Core
Copyright (C) Microsoft Corporation. All rights reserved.

  Restore completed in 31.32 ms for /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/dotnetcore-sourcelink-test-bug.csproj.
  dotnetcore-sourcelink-test-bug -> /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/bin/Release/netstandard2.0/dotnetcore-sourcelink-test-bug.dll
  dotnetcore-sourcelink-test-bug -> /Users/shiftkey/src/dotnetcore-sourcelink-test-bug/bin/Release/net45/dotnetcore-sourcelink-test-bug.dll
sourcelink test passed: lib/net45/dotnetcore-sourcelink-test-bug.dll
sourcelink test passed: lib/netstandard2.0/dotnetcore-sourcelink-test-bug.dll
```

## But what is happening?

Why does this file now break SourceLink? That's what I'm trying to figure out
next. Looking at the file itself, it's a generated file that isn't meant to be
in version control anyway:

```c#
$ cat ./obj/Release/net45/dotnetcore-sourcelink-test-bug.AssemblyInfo.cs
//------------------------------------------------------------------------------
// <auto-generated>
//     Generated by the MSBuild WriteCodeFragment class.
// </auto-generated>
//------------------------------------------------------------------------------

using System;
using System.Reflection;

[assembly: System.Reflection.AssemblyCompanyAttribute("dotnetcore-sourcelink-test-bug")]
[assembly: System.Reflection.AssemblyConfigurationAttribute("Release")]
[assembly: System.Reflection.AssemblyFileVersionAttribute("1.0.0.0")]
[assembly: System.Reflection.AssemblyInformationalVersionAttribute("1.0.0+ce516c72cbc60038c9c879798b69ea526fe0fd7b")]
[assembly: System.Reflection.AssemblyProductAttribute("dotnetcore-sourcelink-test-bug")]
[assembly: System.Reflection.AssemblyTitleAttribute("dotnetcore-sourcelink-test-bug")]
[assembly: System.Reflection.AssemblyVersionAttribute("1.0.0.0")]
```

What I need to understand:

 - when this was introduced - `3.0.x` or `3.1.x`?
 - why generated files are being looked at by sourcelink?
 - what needs to be done to fix the bug?
